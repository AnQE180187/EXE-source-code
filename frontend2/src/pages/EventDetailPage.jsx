import React, { useEffect, useState, useCallback } from 'react';
import { useParams, Link, useNavigate } from 'react-router-dom';
import { Heart } from 'lucide-react';
import { getEventById, deleteEvent, updateEvent } from '../services/eventService';
import { createRegistration, getRegistrationStatus, cancelRegistration, initiateDeposit } from '../services/registrationService';
import { toggleFavorite, getFavoriteStatus } from '../services/favoritesService';
import { findOrCreateConversation } from '../services/chatService';
import { useAuth } from '../context/AuthContext';
import Modal from '../components/ui/Modal';
import EventModal from './EventModal';
import DepositModal from './DepositModal'; // Import DepositModal
import './EventDetailPage.css';
import '../components/ui/Button.css';

const EventDetailPage = () => {
  const { id } = useParams();
  const { user, isAuthenticated } = useAuth();
  const navigate = useNavigate();

  const [event, setEvent] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
  const [registrationStatus, setRegistrationStatus] = useState(null);
  const [loadingRegistration, setLoadingRegistration] = useState(false);
  const [isFavorited, setIsFavorited] = useState(false);
  const [loadingFavorite, setLoadingFavorite] = useState(false);
  const [loadingDelete, setLoadingDelete] = useState(false);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);

  const fetchEvent = useCallback(async () => {
    try {
      setLoading(true);
      const eventData = await getEventById(id);
      setEvent(eventData);
    } catch {
      setError('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·ª± ki·ªán. C√≥ th·ªÉ s·ª± ki·ªán kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a.');
    } finally {
      setLoading(false);
    }
  }, [id]);

  const fetchRegistrationStatus = useCallback(async () => {
    if (!isAuthenticated) {
      setRegistrationStatus(null);
      return;
    }
    try {
      const status = await getRegistrationStatus(id);
      setRegistrationStatus(status);
    } catch {
      setRegistrationStatus({ isRegistered: false, status: null });
    }
  }, [id, isAuthenticated]);

  const fetchFavoriteStatus = useCallback(async () => {
    if (!isAuthenticated) {
      setIsFavorited(false);
      return;
    }
    try {
      const status = await getFavoriteStatus(id);
      setIsFavorited(status.isFavorited || false);
    } catch {
      setIsFavorited(false);
    }
  }, [id, isAuthenticated]);

  useEffect(() => { fetchEvent(); }, [fetchEvent]);
  useEffect(() => { fetchRegistrationStatus(); }, [fetchRegistrationStatus]);
  useEffect(() => { fetchFavoriteStatus(); }, [fetchFavoriteStatus]);

  // ---- REGISTER ----
  const handleRegistration = async () => {
    if (!isAuthenticated) return navigate(`/login?redirect=/events/${id}`);
    try {
      setLoadingRegistration(true);
      await createRegistration(id);
      setIsSuccessPopupOpen(true);
      await Promise.all([fetchEvent(), fetchRegistrationStatus()]);
      setTimeout(() => setIsSuccessPopupOpen(false), 7000); // auto close after 7s
    } catch (error) {
      alert(error);
    } finally {
      setLoadingRegistration(false);
    }
  };

  // ---- CANCEL (CONFIRM + SUCCESS POPUP) ----
  const openCancelConfirm = (kind = 'REGISTER') => {
    setCancelKind(kind);
    setIsCancelConfirmOpen(true);
  };

  const handleCancelRegistration = async () => {
    if (!isAuthenticated) return;
    
    const isConfirmed = window.confirm(
      registrationStatus.status === 'DEPOSITED' 
        ? 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë·∫∑t c·ªçc kh√¥ng? Ti·ªÅn c·ªçc s·∫Ω ƒë∆∞·ª£c ho√†n l·∫°i.'
        : 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒëƒÉng k√Ω kh√¥ng?'
    );
    
    if (!isConfirmed) return;
    
    try {
      setLoadingRegistration(true);
      await cancelRegistration(id);
      alert(
        registrationStatus.status === 'DEPOSITED' 
          ? 'H·ªßy ƒë·∫∑t c·ªçc th√†nh c√¥ng! Ti·ªÅn s·∫Ω ƒë∆∞·ª£c ho√†n l·∫°i trong 3-5 ng√†y.'
          : 'H·ªßy ƒëƒÉng k√Ω th√†nh c√¥ng!'
      );
      await Promise.all([fetchEvent(), fetchRegistrationStatus()]);
      setTimeout(() => setIsCancelSuccessOpen(false), 7000); // auto close after 7s
    } catch (error) {
      alert(error);
    } finally {
      setLoadingRegistration(false);
    }
  };

  // Step 1: User clicks "ƒê·∫∑t c·ªçc", open phone number modal
  const handleDeposit = () => {
    if (!isAuthenticated) return navigate(`/login?redirect=/events/${id}`);
    // Navigate to payment page with event info
    navigate('/payment', { state: { event } });
  };

  const handleToggleFavorite = async () => {
    if (!isAuthenticated) return navigate(`/login?redirect=/events/${id}`);
    try {
      setLoadingFavorite(true);
      const result = await toggleFavorite(id);
      setIsFavorited(result.isFavorited);
    } catch (error) {
      alert(error.message);
    } finally {
      setLoadingFavorite(false);
    }
  };

  const handleDelete = async () => {
    try {
      setLoadingDelete(true);
      await deleteEvent(id);
      navigate('/events');
    } catch (error) {
      setError('Kh√¥ng th·ªÉ x√≥a s·ª± ki·ªán: ' + (error.message || error));
    } finally {
      setLoadingDelete(false);
      setIsDeleteModalOpen(false);
    }
  };

  const handleChatWithOrganizer = async () => {
    if (!isAuthenticated) {
      return navigate(`/login?redirect=/events/${id}`);
    }
    try {
      const conversation = await findOrCreateConversation(
        event.id,
        user.sub,
        event.organizerId,
      );
      navigate(`/chat?conversationId=${conversation.id}`);
    } catch (error) {
      alert('Could not start a conversation with the organizer.');
    }
  };

  const handleEditSubmit = async (data) => {
    try {
      await updateEvent(id, data);
      await fetchEvent();
      setIsEditModalOpen(false);
    } catch (error) {
      alert(error);
    }
  };

  if (loading) return <div className="loading-message">ƒêang t·∫£i...</div>;
  if (error) return <div className="error-message">{error}</div>;
  if (!event) return <div className="no-results">Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán.</div>;

  const isOrganizer = user && user.sub === event.organizerId;
  const eventDate = new Date(event.startAt).toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  const eventTime = new Date(event.startAt).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

  return (
    <>
      <EventModal
        isOpen={isEditModalOpen}
        onClose={() => setIsEditModalOpen(false)}
        onComplete={handleEditSubmit}
        initialData={event}
      />
      <Modal
        isOpen={isDeleteModalOpen}
        onClose={() => setIsDeleteModalOpen(false)}
        onConfirm={handleDelete}
        title="X√°c nh·∫≠n x√≥a s·ª± ki·ªán"
      >
        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·ª± ki·ªán n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c v√† s·∫Ω x√≥a t·∫•t c·∫£ d·ªØ li·ªáu li√™n quan.</p>
      </Modal>

      <div className="event-detail-page">
        <div className="event-detail__main">
          <div className="event-header">
            <span className="event-status">{event.status}</span>
            <h1 className="event-title">{event.title}</h1>
            <div className="organizer-info">
              <img src={event.organizer.avatarUrl || `https://i.pravatar.cc/150?u=${event.organizer.id}`} alt={event.organizer.name} className="organizer-avatar" />
              <span>T·ªï ch·ª©c b·ªüi <strong>{event.organizer.name}</strong></span>
            </div>
          </div>
          
          <div className="event-description">
            <h3>Chi ti·∫øt s·ª± ki·ªán</h3>
            <p>{event.description}</p>
          </div>
        </div>
      )}

      {/* ‚úÖ Popup H·ªßy th√†nh c√¥ng */}
      {isCancelSuccessOpen && (
        <div className="success-popup">
          <div className="success-popup-content">
            <h2>H·ªßy ƒëƒÉng k√Ω th√†nh c√¥ng üéâ</h2>
            <div className="success-icon">
              <CheckCircle size={48} color="#22C55E" />
            </div>
            <p>B·∫°n ƒë√£ h·ªßy {cancelKind === 'DEPOSIT' ? 'ƒë·∫∑t c·ªçc' : 'ƒëƒÉng k√Ω'} s·ª± ki·ªán <b>{event.title}</b>.</p>
            <div className="popup-buttons">
              <button onClick={() => setIsCancelSuccessOpen(false)} className="button button--outline">ƒê√≥ng</button>
            </div>
          </div>
        </div>
      )}

      {/* ===== HERO ===== */}
      <div className="event-detail-page">
        <div className="event-hero">
          <div className="event-hero__overlay">
            <div className="event-hero__content">
              <div className="event-hero__breadcrumb">
                <button className="back-button" onClick={() => navigate(-1)}>
                  <ArrowLeft size={20} /> Quay l·∫°i
                </button>
              </div>
              <div className="event-hero__status">
                <span className={`status-badge status-${event.status.toLowerCase()}`}>
                  {event.status === 'ACTIVE' && <CheckCircle size={16} />}
                  {event.status === 'ENDED' && <AlertCircle size={16} />}
                  {event.status}
                </span>
              </div>

              {/* Favorite Button */}
              {isAuthenticated && (
                <button
                  className={`favorite-button ${isFavorited ? 'favorited' : ''}`}
                  onClick={handleToggleFavorite}
                  disabled={loadingFavorite}
                  title={isFavorited ? 'B·ªè y√™u th√≠ch' : 'Th√™m v√†o y√™u th√≠ch'}
                >
                  <Heart 
                    size={20} 
                    fill={isFavorited ? '#fff' : 'none'} 
                    color={isFavorited ? '#fff' : '#666'}
                  />
                  {loadingFavorite ? '...' : (isFavorited ? 'ƒê√£ y√™u th√≠ch' : 'Y√™u th√≠ch')}
                </button>
              )}

              {isAuthenticated ? (
                <>
                  {registrationStatus?.isRegistered ? (
                    <>
                      {registrationStatus.status === 'DEPOSITED' ? (
                        <>
                          <button className="button button--success" disabled>
                            ‚úì ƒê√£ ƒë·∫∑t c·ªçc
                          </button>
                          <Link 
                            to={`/events/${id}/ticket`}
                            className="button button--secondary"
                          >
                            Xem v√© c·ªßa t√¥i
                          </Link>
                          <button 
                            className="button button--ghost" 
                            onClick={handleCancelRegistration}
                            disabled={loadingRegistration}
                          >
                            {loadingRegistration ? 'ƒêang h·ªßy...' : 'H·ªßy ƒë·∫∑t c·ªçc'}
                          </button>
                        </>
                      ) : (
                        <>
                          <button className="button button--success" disabled>
                            ‚úì ƒê√£ ƒëƒÉng k√Ω
                          </button>
                          {event.price > 0 && (
                            <button className="button" onClick={handleDeposit}>
                              ƒê·∫∑t c·ªçc
                            </button>
                          )}
                          <button 
                            className="button button--ghost" 
                            onClick={handleCancelRegistration}
                            disabled={loadingRegistration}
                          >
                            {loadingRegistration ? 'ƒêang h·ªßy...' : 'H·ªßy ƒëƒÉng k√Ω'}
                          </button>
                        </>
                      )}
                    </>
                  ) : (
                    <button 
                      className="button button--secondary" 
                      onClick={handleRegistration}
                      disabled={loadingRegistration}
                    >
                      {loadingRegistration ? 'ƒêang ƒëƒÉng k√Ω...' : 'ƒêƒÉng k√Ω ngay'}
                    </button>
                  )}
                </>
              ) : (
                <Link to={`/login?redirect=/events/${id}`} className="button button--secondary">
                  ƒêƒÉng nh·∫≠p ƒë·ªÉ tham gia
                </Link>
              )}
            </div>
             {isOrganizer && (
                <div className="sidebar-card__footer">
                  <button onClick={() => setIsEditModalOpen(true)} className="button">Ch·ªânh s·ª≠a</button>
                  <button 
                    className="button button--ghost" 
                    onClick={() => setIsDeleteModalOpen(true)}
                    disabled={loadingDelete}
                  >
                    {loadingDelete ? 'ƒêang x√≥a...' : 'X√≥a'}
                  </button>
                </div>
              )}
          </div>
        </aside>
      </div>

      {/* ===== Lightbox ·∫£nh ===== */}
      {isImageOpen && (
        <div className="image-lightbox-backdrop" onClick={closeImage}>
          <div
            className="image-lightbox-content"
            onClick={(e) => e.stopPropagation()}
            role="dialog"
            aria-modal="true"
            aria-label="Xem ·∫£nh l·ªõn"
          >
            <button className="image-lightbox-close" onClick={closeImage} aria-label="ƒê√≥ng">
              <X size={20} />
            </button>
            <img src={event.imageUrl} alt={event.title} className="image-lightbox-img" />
            <div className="image-lightbox-caption">{event.title}</div>
          </div>
        </div>
      )}
    </>
  );
};

export default EventDetailPage;
